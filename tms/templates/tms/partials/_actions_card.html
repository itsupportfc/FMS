{% load form_filters %}

<div class="card">
    <h3 class="card-header">Actions</h3>

    <div class="space-y-6">
        {% with actions=available_actions %}

            {# Handover #}
            {% if "handover_to_tracking" in actions %}
                <form method="post"
                      action="{% url 'change_status' load.load_id 'handover' %}"
                      class="space-y-3">
                    {% csrf_token %}

                    <label class="form-label">Assign to Tracking Agent</label>
                    <select name="tracking_agent" required class="form-select">
                        <option value="">Select agent...</option>
                        {% for agent in tracking_agents %}
                            <option value="{{ agent.id }}">
                                {% if agent.get_full_name %}
                                    {{ agent.get_full_name }}
                                {% else %}
                                    {{ agent.username }}
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>

                    <textarea name="instructions"
                              placeholder="Special instructions (optional)"
                              class="form-textarea"
                              rows="2"></textarea>

                    <button type="submit" class="btn-primary w-full">Handover to Tracking</button>
                </form>
            {% else %}
                {# Optional UX: if BOOKED but no handover action, show a hint (does not affect logic) #}
                {% if load.status == "booked" %}
                    <div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <p class="text-xs text-gray-600">
                            Handover will appear once required fields are complete (RC uploaded, carrier/truck/driver assigned, and valid stops).
                        </p>
                    </div>
                {% endif %}
            {% endif %}

            {# Start Transit #}
            {% if "start_transit" in actions %}
                <form method="post"
                      action="{% url 'change_status' load.load_id 'start_transit' %}"
                      class="space-y-3">
                    {% csrf_token %}
                    <button type="submit" class="btn-primary w-full">Start Transit</button>
                </form>
            {% endif %}

            {# Mark Delivered #}
            {% if "mark_delivered" in actions %}
                <form method="post"
                      action="{% url 'change_status' load.load_id 'mark_delivered' %}"
                      class="space-y-3">
                    {% csrf_token %}
                    <button type="submit" class="btn-primary w-full">Mark as Delivered</button>
                </form>
            {% endif %}

            {# Complete Load #}
            {% if "complete_load" in actions %}
                <form method="post"
                      action="{% url 'change_status' load.load_id 'complete_load' %}"
                      class="space-y-3">
                    {% csrf_token %}
                    <button type="submit" class="btn-secondary w-full">Complete Load</button>
                </form>
            {% endif %}

            {# Cancel #}
            {% if "cancel_load" in actions %}
                <button type="button" onclick="showCancelModal()" class="btn-danger w-full">Cancel Load</button>
            {% endif %}

        {% endwith %}
    </div>
</div>
