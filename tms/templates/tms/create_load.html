{% extends "base.html" %}

{% block content %}
    <div class="page-header">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Create Load</h1>
                <p class="text-sm text-gray-600 mt-1">Book a load and define the route stops.</p>
            </div>
            <div>
                <button type="submit" form="create-load-form" class="btn-primary">Create Load</button>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-8 py-8">
        <form id="create-load-form" method="post" class="space-y-8">
            {% csrf_token %}

            {% if form.non_field_errors %}<div class="alert-error">{{ form.non_field_errors }}</div>{% endif %}

            <!-- Load -->
            <div class="card">
                <div class="section-title">Load</div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="form-label" for="{{ form.load_id.id_for_label }}">Load ID</label>
                        {{ form.load_id }}
                        {% for e in form.load_id.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
                    </div>

                    <div>
                        <label class="form-label" for="{{ form.broker.id_for_label }}">Broker</label>
                        {{ form.broker }}
                        {% for e in form.broker.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
                    </div>

                    <div>
                        <label class="form-label" for="{{ form.carrier.id_for_label }}">Carrier</label>
                        {{ form.carrier }}
                        {% for e in form.carrier.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
                    </div>

                    <!-- ✅ FIX: HTMX target exists -->
                    <div id="carrier-assets"
                         class="grid grid-cols-1 md:grid-cols-2 gap-6 md:col-span-2">
                        {% include "tms/partials/carrier_assets.html" %}

                    </div>
                </div>
            </div>

            <!-- Stops -->
            <div class="card">
                <div class="flex items-center justify-between">
                    <div class="section-title mb-0">Stops</div>

                    <button type="button"
                            class="btn-secondary btn-sm"
                            hx-get="{% url 'load_stop_row' %}"
                            hx-target="#stops-container"
                            hx-swap="beforeend"
                            hx-vals='js:{"index": document.getElementById("id_stops-TOTAL_FORMS").value }'>
                        + Add Stop
                    </button>
                </div>

                <div class="mt-6">
                    {{ stop_formset.management_form }}

                    {% if stop_formset.non_form_errors %}<div class="alert-error mb-4">{{ stop_formset.non_form_errors }}</div>{% endif %}

                    <div id="stops-container" class="space-y-4">
                        {% for stop_form in stop_formset %}
                            {% include "tms/partials/_stop_row.html" with stop_form=stop_form index=forloop.counter0 next_total=stop_formset.total_form_count %}

                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Financial -->
            <div class="card">
                <div class="section-title">Financial</div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="form-label" for="{{ form.rate.id_for_label }}">Rate</label>
                        {{ form.rate }}
                        {% for e in form.rate.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
                    </div>
                    <div>
                        <label class="form-label" for="{{ form.miles.id_for_label }}">Miles</label>
                        {{ form.miles }}
                        {% for e in form.miles.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
                    </div>
                    <div>
                        <label class="form-label">Rate / Mile</label>
                        <div class="form-input bg-gray-50">
                            <span id="rate-per-mile">—</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Remarks -->
            <div class="card">
                <div class="section-title">Notes</div>
                <label class="form-label" for="{{ form.remarks.id_for_label }}">Remarks</label>
                {{ form.remarks }}
                {% for e in form.remarks.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
            </div>

            <div class="flex justify-end">
                <button type="submit" class="btn-primary">Create Load</button>
            </div>
        </form>
    </div>

    <script>
        // RPM calc (optional but useful)
        (function() {
            const rateInput = document.getElementById("id_rate");
            const milesInput = document.getElementById("id_miles");
            const rpm = document.getElementById("rate-per-mile");

            function calc() {
                const r = parseFloat(rateInput?.value) || 0;
                const m = parseFloat(milesInput?.value) || 0;
                rpm.textContent = (r > 0 && m > 0) ? ("$" + (r / m).toFixed(2)) : "—";
            }
            rateInput?.addEventListener("input", calc);
            milesInput?.addEventListener("input", calc);
            calc();
        })();

        // Appointment toggle (only JS you need)
        function syncApptFields(row) {
            const sel = row.querySelector('select[name$="-appointment_type"]');
            const wrap = row.querySelector('[data-appt-fields]');
            if (!sel || !wrap) return;

            const isAppt = sel.value === "appt";
            wrap.hidden = !isAppt;

            if (!isAppt) {
                row.querySelector('[data-appt-start]')?.setAttribute("value", "");
                row.querySelector('[data-appt-end]')?.setAttribute("value", "");
                const s = row.querySelector('[data-appt-start]');
                const e = row.querySelector('[data-appt-end]');
                if (s) s.value = "";
                if (e) e.value = "";
            }
        }

        document.addEventListener('change', function(e) {
            const sel = e.target.closest('[data-appt-type]');
            if (!sel) return;
            const row = sel.closest('[data-stop-row]');
            if (!row) return;
            syncApptFields(row);
        });

        document.querySelectorAll('[data-stop-row]').forEach(syncApptFields);

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            // when a new stop is appended into stops-container
            if (evt.target && evt.target.id === "stops-container") {
                evt.target.querySelectorAll('[data-stop-row]').forEach(syncApptFields);
            }
        });
    </script>

{% endblock %}
