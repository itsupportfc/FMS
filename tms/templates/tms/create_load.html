{% extends "base.html" %}

{% load form_filters %}

{% block content %}
    <!-- Full-width header spanning the main content area (right of sidebar) -->
    <div class="page-header">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Create New Load</h1>
                <p class="text-sm text-gray-600 mt-1">Complete the form below to create a new load booking</p>
            </div>
            <div>
                <button type="submit" form="create-load-form" class="btn-primary">Create Load</button>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-8 pb-10">
        <form id="create-load-form" method="post" class="space-y-8">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="rounded-lg bg-red-50 border border-red-200 px-6 py-4 text-[15px] text-red-700">
                    {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                </div>
            {% endif %}

            <!-- Booking Information -->
            <div class="card">
                <h2 class="card-header">Booking Information</h2>
                <div class="grid gap-6 grid-cols-2">
                    <div class="space-y-2">
                        <label for="id_load_id" class="form-label">Load ID</label>
                        {{ form.load_id|add_class:"form-input" }}
                        {% if form.load_id.errors %}<p class="form-error">{{ form.load_id.errors.0 }}</p>{% endif %}
                    </div>
                    <div class="space-y-2">
                        <label for="id_broker" class="form-label">
                            Broker <span class="text-red-600">*</span>
                        </label>
                        {{ form.broker|add_class:"form-select" }}
                        {% if form.broker.errors %}<p class="form-error">{{ form.broker.errors.0 }}</p>{% endif %}
                    </div>

                    {# IMPORTANT:
                       In your new Load model, "status" should NOT be editable on create.
                       If you removed status from LoadForm fields, this block will safely render nothing.
                       If you still have it in your form, consider removing it.
                    #}
                    <div class="space-y-2">
                        <label class="form-label">Status</label>
                        <div class="form-input bg-gray-50 text-gray-700">Pending</div>
                    </div>

                </div>
            </div>

            <!-- Carrier & Assets -->
            <div class="card">
                <h2 class="section-title">Carrier & Assets</h2>
                <div class="grid gap-6 grid-cols-2">
                    <div class="space-y-2">
                        <label for="id_carrier" class="form-label">Carrier</label>
                        {{ form.carrier|add_class:"form-select" }}
                        {% if form.carrier.errors %}<p class="form-error">{{ form.carrier.errors.0 }}</p>{% endif %}
                    </div>
                    <div id="carrier-assets" class="space-y-6">
                        <div class="space-y-2">
                            <label for="id_driver" class="form-label">Driver</label>
                            {{ form.driver|add_class:"form-select" }}
                            {% if form.driver.errors %}<p class="form-error">{{ form.driver.errors.0 }}</p>{% endif %}
                        </div>
                        <div class="space-y-2">
                            <label for="id_truck" class="form-label">Truck</label>
                            {{ form.truck|add_class:"form-select" }}
                            {% if form.truck.errors %}<p class="form-error">{{ form.truck.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Route Information (MULTI-STOP) -->
            <div class="card">
                <h2 class="section-title">Route Information</h2>
                <p class="text-sm text-gray-600 mt-1">
                    Add at least 2 stops (Pickup + Delivery). For APPT stops, provide at least an appointment start (or a window).
                </p>

                {{ stop_formset.management_form }}

                {% if stop_formset.non_form_errors %}
                    <div class="rounded-lg bg-red-50 border border-red-200 px-6 py-4 text-[15px] text-red-700 mt-4">
                        {% for error in stop_formset.non_form_errors %}<p>{{ error }}</p>{% endfor %}
                    </div>
                {% endif %}

                <div class="space-y-6 mt-6">
                    {% for stop_form in stop_formset %}
                        <div class="rounded-xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold text-gray-900">Stop {{ forloop.counter }}</h3>
                            </div>

                            {% if stop_form.non_field_errors %}
                                <div class="rounded-lg bg-red-50 border border-red-200 px-4 py-3 text-[14px] text-red-700 mt-3">
                                    {% for error in stop_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                                </div>
                            {% endif %}

                            <div class="grid gap-6 grid-cols-2 mt-4">
                                <div class="space-y-2">
                                    <label class="form-label">Stop Type</label>
                                    {{ stop_form.stop_type|add_class:"form-select" }}
                                    {% if stop_form.stop_type.errors %}<p class="form-error">{{ stop_form.stop_type.errors.0 }}</p>{% endif %}
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Facility</label>
                                    {{ stop_form.facility|add_class:"form-select" }}
                                    {% if stop_form.facility.errors %}<p class="form-error">{{ stop_form.facility.errors.0 }}</p>{% endif %}
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Sequence</label>
                                    {{ stop_form.sequence|add_class:"form-input" }}
                                    {% if stop_form.sequence.errors %}<p class="form-error">{{ stop_form.sequence.errors.0 }}</p>{% endif %}
                                    <p class="text-xs text-gray-500">Route order: 1,2,3...</p>
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Appointment Type</label>
                                    {{ stop_form.appointment_type|add_class:"form-select" }}
                                    {% if stop_form.appointment_type.errors %}
                                        <p class="form-error">{{ stop_form.appointment_type.errors.0 }}</p>
                                    {% endif %}
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Appt Start</label>
                                    {{ stop_form.appt_start|add_class:"form-input" }}
                                    {% if stop_form.appt_start.errors %}<p class="form-error">{{ stop_form.appt_start.errors.0 }}</p>{% endif %}
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Appt End</label>
                                    {{ stop_form.appt_end|add_class:"form-input" }}
                                    {% if stop_form.appt_end.errors %}<p class="form-error">{{ stop_form.appt_end.errors.0 }}</p>{% endif %}
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Reference #</label>
                                    {{ stop_form.reference_number|add_class:"form-input" }}
                                    {% if stop_form.reference_number.errors %}
                                        <p class="form-error">{{ stop_form.reference_number.errors.0 }}</p>
                                    {% endif %}
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Pieces</label>
                                    {{ stop_form.pieces|add_class:"form-input" }}
                                    {% if stop_form.pieces.errors %}<p class="form-error">{{ stop_form.pieces.errors.0 }}</p>{% endif %}
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Stop Weight</label>
                                    {{ stop_form.weight|add_class:"form-input" }}
                                    {% if stop_form.weight.errors %}<p class="form-error">{{ stop_form.weight.errors.0 }}</p>{% endif %}
                                </div>

                                <div class="space-y-2">
                                    <label class="form-label">Status</label>
                                    <div class="form-input bg-gray-50 text-gray-700">Pending</div>
                                </div>

                                <div class="space-y-2 col-span-2">
                                    <label class="form-label">Special Instructions</label>
                                    {{ stop_form.special_instructions|add_class:"form-input" }}
                                    {% if stop_form.special_instructions.errors %}
                                        <p class="form-error">{{ stop_form.special_instructions.errors.0 }}</p>
                                    {% endif %}
                                </div>

                                <div class="space-y-2 col-span-2">
                                    <label class="form-label">Notes</label>
                                    {{ stop_form.notes|add_class:"form-input" }}
                                    {% if stop_form.notes.errors %}<p class="form-error">{{ stop_form.notes.errors.0 }}</p>{% endif %}
                                </div>
                            </div>

                            {% for hidden in stop_form.hidden_fields %}{{ hidden }}{% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Financial Details -->
            <div class="card">
                <h2 class="section-title">Financial Details</h2>

                <div class="grid gap-6 grid-cols-3">
                    <div class="space-y-2">
                        <label for="id_rate" class="form-label">Rate (USD)</label>
                        {{ form.rate|add_class:"form-input" }}
                        {% if form.rate.errors %}<p class="form-error">{{ form.rate.errors.0 }}</p>{% endif %}
                    </div>

                    <div class="space-y-2">
                        <label for="id_miles" class="form-label">Miles</label>
                        {{ form.miles|add_class:"form-input" }}
                        {% if form.miles.errors %}<p class="form-error">{{ form.miles.errors.0 }}</p>{% endif %}
                    </div>

                    <div class="space-y-2">
                        <label class="form-label">Rate Per Mile</label>
                        <div class="form-input">
                            <span id="rate-per-mile">—</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="card">
                <h2 class="section-title">Additional Information</h2>
                <div class="space-y-2">
                    {{ form.remarks|add_class:"form-input" }}
                    {% if form.remarks.errors %}<p class="form-error">{{ form.remarks.errors.0 }}</p>{% endif %}
                </div>
            </div>

        </form>
    </div>

    <script>
        // Calculate rate per mile
        const rateInput = document.getElementById('id_rate');
        const milesInput = document.getElementById('id_miles');
        const rpmDisplay = document.getElementById('rate-per-mile');

        function calculateRPM() {
            const rate = parseFloat(rateInput.value) || 0;
            const miles = parseFloat(milesInput.value) || 0;
            if (rate > 0 && miles > 0) {
                const rpm = (rate / miles).toFixed(2);
                rpmDisplay.textContent = '$' + rpm;
            } else {
                rpmDisplay.textContent = '—';
            }
        }

        rateInput?.addEventListener('input', calculateRPM);
        milesInput?.addEventListener('input', calculateRPM);
        calculateRPM();
    </script>

{% endblock %}
